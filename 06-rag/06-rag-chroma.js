import { config } from "dotenv";
import { ChatOpenAI, OpenAIEmbeddings } from "@langchain/openai";
import { Chroma } from "@langchain/community/vectorstores/chroma"; // éœ€è¦å®‰è£… @langchain/community å’Œ chromadb
import { PromptTemplate } from "@langchain/core/prompts";
import { StringOutputParser } from "@langchain/core/output_parsers";

config();

// 1ï¸âƒ£ åˆå§‹åŒ–åµŒå…¥æ¨¡åž‹
const embeddings = new OpenAIEmbeddings({
  model: "qwen3-embedding:4b",
  configuration: {
    baseURL: process.env.OLLAMA_BASE_URL,
  },
});

// 2ï¸âƒ£ åˆå§‹åŒ– LLM
const model = new ChatOpenAI({
  model: "gpt-4",
});

async function main() {
  // 3ï¸âƒ£ è¿žæŽ¥åˆ° Chroma å‘é‡æ•°æ®åº“
  const vectorStore = await Chroma.fromExistingCollection(embeddings, {
    collectionName: "tech-knowledge-base",
    url: "http://192.168.0.99:8300",
  });

  // 4ï¸âƒ£ å¡«å……æ•°æ® (ä»…åœ¨ç¬¬ä¸€æ¬¡è¿è¡Œæˆ–éœ€è¦æ›´æ–°æ—¶æ‰§è¡Œ)
  const count = await vectorStore.collection.count();
  if (count === 0) {
    console.log("æ£€æµ‹åˆ°æ•°æ®åº“ä¸ºç©ºï¼Œæ­£åœ¨åˆå§‹åŒ–æ•°æ®...");

    // å‡†å¤‡æ–‡æ¡£å†…å®¹
    const rawTexts = [
      "Paresh æ­£åœ¨ä½¿ç”¨ LangChain æž„å»ºä¸€ä¸ªæ™ºèƒ½ä½“ AI åŽç«¯ã€‚",
      "ä»–å¸Œæœ›é€šè¿‡æž„å»º RAGã€æ™ºèƒ½ä½“å’Œç”µå­å•†åŠ¡ AI åº”ç”¨è¾¾åˆ° 15 LPA çš„ç›®æ ‡ã€‚",
      "LangChain å¸®åŠ©è½»æ¾åˆ›å»ºæ™ºèƒ½ä½“ã€é“¾ã€å·¥å…·å’Œå‘é‡å†…å­˜ã€‚",
      "Paresh ä»Šå¹´ 20 å²ã€‚",
      "å¾®æœåŠ¡æž¶æž„æ˜¯ä¸€ç§å°†åº”ç”¨ç¨‹åºæž„å»ºä¸ºæ¾æ•£è€¦åˆæœåŠ¡é›†åˆçš„è®¾è®¡æ–¹æ³•ã€‚æ¯ä¸ªæœåŠ¡éƒ½æœ‰ç‰¹å®šçš„ä¸šåŠ¡åŠŸèƒ½ï¼Œå¯ä»¥ç‹¬ç«‹å¼€å‘ã€éƒ¨ç½²å’Œæ‰©å±•ã€‚",
      "RESTful API è®¾è®¡éµå¾ªèµ„æºå¯¼å‘çš„æž¶æž„é£Žæ ¼ï¼Œä½¿ç”¨ HTTP åŠ¨è¯è¡¨ç¤ºæ“ä½œï¼Œé€šè¿‡çŠ¶æ€ç è¡¨è¾¾ç»“æžœã€‚",
      "æ•°æ®åº“ç´¢å¼•æ˜¯æé«˜æŸ¥è¯¢æ€§èƒ½çš„å…³é”®æŠ€æœ¯ã€‚B+æ ‘ç´¢å¼•é€‚ç”¨äºŽèŒƒå›´æŸ¥è¯¢ï¼Œå“ˆå¸Œç´¢å¼•é€‚ç”¨äºŽç²¾ç¡®åŒ¹é…ã€‚",
      "æŒç»­é›†æˆå’ŒæŒç»­éƒ¨ç½²ï¼ˆCI/CDï¼‰æ˜¯çŽ°ä»£è½¯ä»¶å¼€å‘çš„æœ€ä½³å®žè·µã€‚Jenkinsã€GitLab CI å’Œ GitHub Actions æ˜¯å¸¸ç”¨çš„å·¥å…·ã€‚",
      "å®¹å™¨åŒ–æŠ€æœ¯é€šè¿‡ Docker å’Œ Kubernetes å®žçŽ°äº†åº”ç”¨çš„å¯ç§»æ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚",
      "ä»£ç å®¡æŸ¥æ˜¯ä¿è¯ä»£ç è´¨é‡çš„é‡è¦çŽ¯èŠ‚ã€‚é€šè¿‡åŒäº‹ä¹‹é—´çš„ç›¸äº’å®¡æŸ¥ï¼Œå¯ä»¥å‘çŽ°æ½œåœ¨é—®é¢˜ã€åˆ†äº«çŸ¥è¯†ã€‚",
      "è½¯ä»¶æµ‹è¯•é‡‘å­—å¡”åŒ…æ‹¬å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•å’Œç«¯åˆ°ç«¯æµ‹è¯•ã€‚å•å…ƒæµ‹è¯•å æ¯”æœ€å¤§ï¼Œè¿è¡Œæœ€å¿«ã€‚",
      "ç³»ç»Ÿè®¾è®¡ä¸­çš„CAPå®šç†æŒ‡å‡ºåˆ†å¸ƒå¼ç³»ç»Ÿæ— æ³•åŒæ—¶æ»¡è¶³ä¸€è‡´æ€§ã€å¯ç”¨æ€§å’Œåˆ†åŒºå®¹é”™æ€§ã€‚",
      "æ¶ˆæ¯é˜Ÿåˆ—å¦‚ RabbitMQ å’Œ Kafka åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­èµ·ç€å¼‚æ­¥é€šä¿¡å’Œè§£è€¦çš„ä½œç”¨ã€‚",
      "ç¼“å­˜ç­–ç•¥æ˜¯æå‡ç³»ç»Ÿæ€§èƒ½çš„é‡è¦æ‰‹æ®µã€‚Redis å’Œ Memcached æ˜¯å¸¸ç”¨çš„åˆ†å¸ƒå¼ç¼“å­˜è§£å†³æ–¹æ¡ˆã€‚",
      "ç³»ç»Ÿå®‰å…¨è®¾è®¡éœ€è¦éµå¾ªæœ€å°æƒé™åŽŸåˆ™ã€‚HTTPSã€èº«ä»½è®¤è¯å’ŒæŽˆæƒæœºåˆ¶æ˜¯ä¿æŠ¤ç³»ç»Ÿå®‰å…¨çš„åŸºçŸ³ã€‚",
      "æ€§èƒ½ä¼˜åŒ–éœ€è¦ä»Žå¤šä¸ªç»´åº¦è¿›è¡Œã€‚æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–ã€åº”ç”¨å±‚ä¼˜åŒ–å’Œå‰ç«¯ä¼˜åŒ–éƒ½æ˜¯å…³é”®çŽ¯èŠ‚ã€‚",
      "é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰æ˜¯ä¸€ç§å¤æ‚è½¯ä»¶ç³»ç»Ÿçš„è®¾è®¡æ–¹æ³•è®ºã€‚æ ¸å¿ƒæ¦‚å¿µåŒ…æ‹¬é™ç•Œä¸Šä¸‹æ–‡ã€èšåˆå’Œé¢†åŸŸäº‹ä»¶ã€‚",
      "äº‹ä»¶é©±åŠ¨æž¶æž„é€šè¿‡äº‹ä»¶çš„å‘å¸ƒå’Œè®¢é˜…å®žçŽ°ç³»ç»Ÿç»„ä»¶ä¹‹é—´çš„æ¾è€¦åˆã€‚",
      "äº‘åŽŸç”Ÿåº”ç”¨è®¾è®¡éµå¾ªåäºŒè¦ç´ åº”ç”¨åŽŸåˆ™ã€‚",
      "æœåŠ¡ç½‘æ ¼å¦‚ Istio å’Œ Linkerd æä¾›äº†å¾®æœåŠ¡é—´é€šä¿¡çš„å¯è§‚æµ‹æ€§ã€å®‰å…¨æ€§å’Œæµé‡ç®¡ç†èƒ½åŠ›ã€‚",
      "Git ç‰ˆæœ¬æŽ§åˆ¶æ˜¯çŽ°ä»£è½¯ä»¶å¼€å‘çš„åŸºç¡€ã€‚åˆ†æ”¯ç­–ç•¥å¦‚ Git Flow æŒ‡å¯¼å›¢é˜Ÿåä½œå¼€å‘ã€‚",
      "æŽ¥å£éš”ç¦»åŽŸåˆ™ï¼ˆISPï¼‰å»ºè®®å°†å¤§åž‹æŽ¥å£æ‹†åˆ†ä¸ºå¤šä¸ªå°åž‹ã€ç‰¹å®šçš„æŽ¥å£ã€‚",
      "é«˜å¯ç”¨ç³»ç»Ÿè®¾è®¡éœ€è¦è€ƒè™‘å†—ä½™ã€æ•…éšœè½¬ç§»å’Œè´Ÿè½½å‡è¡¡ã€‚",
      "é¢å‘å¯¹è±¡è®¾è®¡åŽŸåˆ™åŒ…æ‹¬å°è£…ã€ç»§æ‰¿å’Œå¤šæ€ã€‚SOLID åŽŸåˆ™æä¾›äº†ç¼–å†™å¯ç»´æŠ¤ä»£ç çš„æŒ‡å¯¼æ–¹é’ˆã€‚",
      "API ç½‘å…³æ˜¯å¾®æœåŠ¡æž¶æž„çš„ç»Ÿä¸€å…¥å£ç‚¹ã€‚å®ƒè´Ÿè´£è¯·æ±‚è·¯ç”±ã€è´Ÿè½½å‡è¡¡å’Œèº«ä»½è®¤è¯ã€‚",
      "åˆ†å¸ƒå¼äº‹åŠ¡ç®¡ç†æ˜¯å¾®æœåŠ¡æž¶æž„ä¸­çš„æŒ‘æˆ˜ã€‚Saga æ¨¡å¼æ˜¯å¤„ç†åˆ†å¸ƒå¼äº‹åŠ¡çš„å¸¸è§æ–¹æ³•ã€‚",
      "ä»£ç é‡æž„æ˜¯æŒç»­æ”¹è¿›ä»£ç è´¨é‡çš„è¿‡ç¨‹ã€‚é‡æž„åº”è¯¥åœ¨æœ‰æµ‹è¯•ä¿éšœçš„æƒ…å†µä¸‹è¿›è¡Œã€‚",
      "æ— æœåŠ¡å™¨æž¶æž„ï¼ˆServerlessï¼‰å…è®¸å¼€å‘è€…ä¸“æ³¨äºŽä¸šåŠ¡é€»è¾‘ä»£ç ï¼Œæ— éœ€ç®¡ç†æœåŠ¡å™¨ã€‚",
      "æœç´¢å¼•æ“ŽæŠ€æœ¯å¦‚ Elasticsearch æä¾›äº†å…¨æ–‡æœç´¢å’Œåˆ†æžèƒ½åŠ›ã€‚",
      "ç³»ç»Ÿç›‘æŽ§å’Œå¯è§‚æµ‹æ€§åŒ…æ‹¬æŒ‡æ ‡ã€æ—¥å¿—å’Œè¿½è¸ªä¸‰å¤§æ”¯æŸ±ã€‚",
      "OAuth 2.0 å’Œ OpenID Connect æ˜¯çŽ°ä»£èº«ä»½è®¤è¯å’ŒæŽˆæƒçš„æ ‡å‡†åè®®ã€‚",
      "GraphQL æ˜¯ä¸€ç§ API æŸ¥è¯¢è¯­è¨€å’Œè¿è¡Œæ—¶ï¼Œå®ƒå…è®¸å®¢æˆ·ç«¯ç²¾ç¡®è¯·æ±‚æ‰€éœ€çš„æ•°æ®ã€‚",
      "è®¾è®¡æ¨¡å¼æ˜¯è½¯ä»¶è®¾è®¡ä¸­å¸¸è§é—®é¢˜çš„è§£å†³æ–¹æ¡ˆã€‚åŒ…æ‹¬åˆ›å»ºåž‹ã€ç»“æž„åž‹å’Œè¡Œä¸ºåž‹æ¨¡å¼ã€‚",
      "Kubernetes æ ¸å¿ƒæ¦‚å¿µåŒ…æ‹¬ Podã€Serviceã€Deploymentã€ConfigMap å’Œ Secretã€‚",
      "æ•°æ®åº“äº‹åŠ¡çš„ ACID ç‰¹æ€§ä¿è¯äº†æ•°æ®çš„ä¸€è‡´æ€§ã€‚",
      "å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼æé«˜äº†ç³»ç»Ÿçš„å¹¶å‘èƒ½åŠ›å’Œå“åº”é€Ÿåº¦ã€‚JavaScript çš„ Promise å’Œ async/await æ˜¯å…¸åž‹ä»£è¡¨ã€‚",
      "è´Ÿè½½æµ‹è¯•å’ŒåŽ‹åŠ›æµ‹è¯•æ˜¯éªŒè¯ç³»ç»Ÿæ€§èƒ½çš„é‡è¦æ‰‹æ®µã€‚",
      "æŠ€æœ¯å€ºæ˜¯å¿«é€Ÿå¼€å‘ä¸­ç§¯ç´¯çš„ä»£ç è´¨é‡å’Œè®¾è®¡é—®é¢˜ã€‚",
      "æ··æ²Œå·¥ç¨‹é€šè¿‡åœ¨ç”Ÿäº§çŽ¯å¢ƒä¸­å¼•å…¥æ•…éšœæ¥éªŒè¯ç³»ç»Ÿçš„éŸ§æ€§ã€‚",
      "API ç‰ˆæœ¬ç®¡ç†æ˜¯ API æ¼”è¿›çš„å…³é”®ç­–ç•¥ã€‚",
      "é¢†åŸŸç‰¹å®šè¯­è¨€ï¼ˆDSLï¼‰æ˜¯ä¸ºç‰¹å®šé—®é¢˜åŸŸè®¾è®¡çš„ç¼–ç¨‹è¯­è¨€ã€‚",
      "åˆ†å¸ƒå¼é”æ˜¯åè°ƒåˆ†å¸ƒå¼ç³»ç»Ÿå¹¶å‘è®¿é—®çš„æœºåˆ¶ã€‚Redis çš„ SETNX æ˜¯å¸¸ç”¨å®žçŽ°æ–¹å¼ã€‚",
      "å“åº”å¼ç¼–ç¨‹æ˜¯ä¸€ç§é¢å‘æ•°æ®æµå’Œå˜åŒ–ä¼ æ’­çš„ç¼–ç¨‹èŒƒå¼ã€‚",
      "åŸºç¡€è®¾æ–½å³ä»£ç ï¼ˆIaCï¼‰é€šè¿‡ä»£ç ç®¡ç† IT åŸºç¡€è®¾æ–½ã€‚Terraform æ˜¯å¸¸ç”¨å·¥å…·ã€‚",
      "æœåŠ¡é™çº§å’Œç†”æ–­æ˜¯ä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§çš„é‡è¦æœºåˆ¶ã€‚",
      "æœç´¢å¼•æ“Žä¼˜åŒ–ï¼ˆSEOï¼‰æŠ€æœ¯åŒ…æ‹¬è¯­ä¹‰åŒ– HTML å’Œåˆç†çš„æ ‡é¢˜å±‚çº§ç»“æž„ã€‚",
      "å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰å…è®¸ç”¨æˆ·ä½¿ç”¨ä¸€å¥—å‡­è¯è®¿é—®å¤šä¸ªåº”ç”¨ã€‚",
      "æ•°æ®æ¹–å’Œæ•°æ®ä»“åº“æ˜¯ä¸¤ç§ä¸åŒçš„æ•°æ®å­˜å‚¨æž¶æž„ã€‚",
      "è¾¹ç¼˜è®¡ç®—å°†è®¡ç®—å’Œæ•°æ®å­˜å‚¨æŽ¨é€åˆ°é è¿‘æ•°æ®æºçš„è¾¹ç¼˜èŠ‚ç‚¹ã€‚",
    ];

    // è½¬æ¢ä¸º LangChain æ–‡æ¡£æ ¼å¼ï¼Œå¹¶ç¡®ä¿ metadata ç»å¯¹ä¸ä¸ºç©º
    const docs = rawTexts.map((text) => ({
      pageContent: text,
      metadata: {
        source: "tech-docs",
        category: "knowledge-base",
      },
    }));

    await vectorStore.addDocuments(docs);
    console.log("âœ… æ•°æ®å…¥åº“å®Œæˆ");
  } else {
    console.log(`ðŸ“Š æ•°æ®åº“ä¸­å·²å­˜åœ¨ ${count} æ¡è®°å½•ï¼Œè·³è¿‡å…¥åº“ã€‚`);
  }

  // 5ï¸âƒ£ æ‰§è¡Œæœç´¢
  const question = "å¦‚ä½•ä½¿ç”¨nodejså®žçŽ°ä¸€ä¸ªç®€å•çš„ OAuth å•ç‚¹ç™»å½•";
  const similarDocs = await vectorStore.similaritySearch(question);

  // 6ï¸âƒ£ æž„å»º RAG é“¾
  // ä½¿ç”¨ \n ç¡®ä¿åœ¨ç”Ÿæˆçš„ä»£ç ä¸­æ˜¯æ¢è¡Œç¬¦
  const context = similarDocs.map((d) => d.pageContent).join("\n");
  const prompt = PromptTemplate.fromTemplate(`ä½¿ç”¨ä¸Šä¸‹æ–‡å›žç­”é—®é¢˜ã€‚

CONTEXT:
{context}

QUESTION:
{question}

ANSWER:`);

  const chain = prompt.pipe(model).pipe(new StringOutputParser());
  const answer = await chain.invoke({ context, question });

  console.log("ðŸ“Œ AI ç­”æ¡ˆ:", answer);
}

main().catch(console.error);
